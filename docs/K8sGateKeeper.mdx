---
id: k8s-gatekeeper
title: Admission Webhook for K8s
description: Kubernetes (K8s) RBAC & ABAC Authorization Middleware based on Casbin
keywords: [k8s-gatekeeper, Kubernetes, K8s]
authors: [ComradeProgrammer]
---

## 1. Overview & Documentation for Casbin K8s-Gatekeeper

Casbin K8s-Gatekeeper is a Kubernetes admission webhook that integrates Casbin as the access control tool. With Casbin K8s-Gatekeeper, you can establish flexible rules to authorize or intercept any operation on K8s resources, without writing any code—just a few lines of declarative Casbin model and policy configurations, using the Casbin ACL (Access Control List) language.

Casbin K8s-Gatekeeper is developed and maintained by the Casbin community. The project repository is available here: [https://github.com/casbin/k8s-gatekeeper](https://github.com/casbin/k8s-gatekeeper)

### 1.1 A Simple Example

For example, you can use the following configuration to forbid images with specified tags from being used in any deployments:

Model:

```ini
[request_definition]
r = obj

[policy_definition]
p = obj, eft

[policy_effect]
e = !some(where (p.eft == deny))

[matchers]
m = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource == "deployments" && \
contain(split(accessWithWildcard(${OBJECT}.Spec.Template.Spec.Containers, "*", "Image"), ":", 1), p.obj)
```

Policy:

```csv
p, "1.14.1", deny
```

These are standard Casbin ACL configurations. If you are familiar with Casbin, this will be easy to understand.

**Advantages of Casbin K8s-Gatekeeper:**
- Easy to use: Write a few lines of ACL instead of lots of code.
- Supports hot configuration updates: No need to restart the plugin to modify configurations.
- Flexible: Arbitrary rules can be made on any K8s resource, which can be explored with `kubectl gatekeeper`.
- Simplifies K8s admission webhook implementation: No need to understand the webhook internals—just specify the resource and write Casbin ACL.
- Maintained by the Casbin community: Contact us for support or questions.

### 1.2 How Casbin K8s-Gatekeeper Works

K8s-Gatekeeper is an admission webhook for K8s that uses [Casbin](/docs/overview) to apply user-defined access control rules, preventing any operation on K8s that the administrator does not want.

Casbin is a powerful, efficient open-source access control library supporting various models. For more details, see [Overview](/docs/overview).

Admission webhooks in K8s are HTTP callbacks that receive 'admission requests' and process them. K8s-Gatekeeper is a 'ValidatingAdmissionWebhook', which can accept or reject admission requests. Admission requests are HTTP requests describing operations on K8s resources (e.g., creating/deleting a deployment). See [K8s official documentation](https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#what-are-admission-webhooks) for more.

### 1.3 Example: How It Works

When someone creates a deployment with a pod running nginx, K8s generates an admission request, which (in YAML) might look like:

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 1
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.14.1
        ports:
        - containerPort: 80
```

This request passes through all middleware, including K8s-Gatekeeper. K8s-Gatekeeper detects all Casbin enforcers stored in K8s's etcd, each with a Casbin model and policy. The admission request is processed by each enforcer; only if all pass is the request accepted.

(If you are unfamiliar with Casbin enforcer, model, or policy, see [Get Started](/docs/get-started)).

For example, to forbid 'nginx:1.14.1' but allow 'nginx:1.3.1', create an enforcer with:

Model:

```ini
[request_definition]
r = obj

[policy_definition]
p = obj, eft

[policy_effect]
e = !some(where (p.eft == deny))

[matchers]
m = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource == "deployments" && \
access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers, 0, "Image") == p.obj
```

Policy:

```csv
p, "nginx:1.13.1", allow
p, "nginx:1.14.1", deny
```

With this enforcer, the previous admission request will be rejected, so K8s will not create the deployment.

## 2. Install K8s-Gatekeeper

There are three installation methods: External webhook, Internal webhook, and Helm.

:::note
Note: These methods are for trying out K8s-gatekeeper and are not secure for production. For production, see [5. Advanced settings](#5-advanced-settings) and make necessary modifications before installation.
:::

### 2.1 Internal Webhook

#### 2.1.1 Step 1: Build the Image

The webhook runs as a service within Kubernetes. To create the service and deployment, build the K8s-gatekeeper image:

```shell
docker build --target webhook -t k8s-gatekeeper .
```

This creates a local image called 'k8s-gatekeeper:latest'.

:::note
If using minikube, run `eval $(minikube -p minikube docker-env)` before `docker build`.
:::

#### 2.1.2 Step 2: Set Up Services and Deployments

```shell
kubectl apply -f config/rbac.yaml
kubectl apply -f config/webhook_deployment.yaml
kubectl apply -f config/webhook_internal.yaml
```

Check with `kubectl get pods`.

#### 2.1.3 Step 3: Install CRD Resources

```shell
kubectl apply -f config/auth.casbin.org_casbinmodels.yaml
kubectl apply -f config/auth.casbin.org_casbinpolicies.yaml
```

### 2.2 External Webhook

K8s-gatekeeper runs outside Kubernetes, accessed as a regular website. Admission webhooks must use HTTPS. For testing, we provide certificates and a private key (not secure). For your own certificate, see [5. Advanced settings](#5-advanced-settings).

The provided certificate is for 'webhook.domain.local'. Modify your host file to point this domain to the K8s-gatekeeper IP.

Then run:

```shell
go mod tidy
go mod vendor
go run cmd/webhook/main.go
kubectl apply -f config/auth.casbin.org_casbinmodels.yaml
kubectl apply -f config/auth.casbin.org_casbinpolicies.yaml
kubectl apply -f config/webhook_external.yaml
```

### 2.3 Install via Helm

#### 2.3.1 Step 1: Build the Image
See [2.1.1 Step 1: Build the Image](#211-step-1-build-the-image).

#### 2.3.2 Helm Installation

```shell
helm install k8sgatekeeper ./k8sgatekeeper
```

## 3. Try K8s-Gatekeeper

### 3.1 Create Casbin Model and Policy

You can create a model and policy via kubectl or the provided go-client.

#### 3.1.1 Create/Update via kubectl

Casbin models are stored in a CRD resource called 'CasbinModel' (see `config/auth.casbin.org_casbinmodels.yaml`).

See examples in `example/allowed_repo/model.yaml`. Key fields:
- `metadata.name`: Must match the related CasbinPolicy object name.
- `spec.enable`: If "false", this model and its policy are ignored.
- `spec.modelText`: The Casbin model text.

Casbin policies are stored in 'CasbinPolicy' (see `config/auth.casbin.org_casbinpolicies.yaml`).

See examples in `example/allowed_repo/policy.yaml`. Key fields:
- `metadata.name`: Must match the related CasbinModel object name.
- `spec.policyItem`: The Casbin policy text.

Apply with:

```shell
kubectl apply -f <filename>
```

K8s-gatekeeper detects new pairs within 5 seconds.

#### 3.1.2 Create/Update via go-client

For automation, use the go-client in `pkg/client`.

In `client.go`, create a client:

```go
func NewK8sGateKeeperClient(externalClient bool) (*K8sGateKeeperClient, error)
```

`externalClient` specifies if K8s-gatekeeper runs inside the cluster.

In `model.go` and `policy.go`, functions are provided to create, delete, and modify models and policies. See `model_test.go` and `policy_test.go` for usage.

#### 3.1.3 Test K8s-gatekeeper

After creating the model and policy in `example/allowed_repo`, try:

```shell
kubectl apply -f example/allowed_repo/testcase/reject_1.yaml
```

K8s should reject this request, citing the webhook. Applying `example/allowed_repo/testcase/approve_2.yaml` should succeed.

## 4. Writing Models and Policies for K8s-gatekeeper

Ensure you are familiar with Casbin Models and Policies. See [Get Started](/docs/get-started) if needed.

### 4.1 Model Request Definition

K8s-gatekeeper always authorizes using an object: the Go Admission Request object. The enforcer is used as:

```go
ok, err := enforcer.Enforce(admission)
```

where `admission` is an `AdmissionReview` object (see [types.go](https://github.com/kubernetes/api/blob/master/admission/v1/types.go)).

The `[request_definition]` should always be:

```ini
[request_definition]
r = obj
```

The name 'obj' is not mandatory, but must be consistent with `[matchers]`.

### 4.2 Model Matchers

Use Casbin's ABAC features to write rules. The built-in expression evaluator does not support indexing in maps/arrays or array expansion, so K8s-gatekeeper provides extension functions. If you need more, open an issue or PR.

See [Function](/docs/function) for more.

#### 4.2.1 Extension Functions

- **access**: Enables indexing into maps/arrays. E.g.,

```ini
[matchers]
m = r.obj.Request.Namespace == "default" && r.obj.Request.Resource.Resource == "deployments" && \
access(r.obj.Request.Object.Object.Spec.Template.Spec.Containers, 0, "Image") == p.obj
```

- **accessWithWildcard**: Expands arrays for matching. E.g.,

```ini
[matchers]
m = contain(split(accessWithWildcard(r.obj.Request.Object.Object.Spec.Template.Spec.Containers, "*", "Image"), ":", 1), p.obj)
```

- **Variable-length argument functions**: `contain()`, `split()`, `len()`, `matchRegex()`
- **Type conversion**: `ParseFloat()`, `ToString()`, `IsNil()`

## 5. Advanced Settings

### 5.1 Certificates

Admission webhooks must use HTTPS. You can use self-signed or regular certificates.

#### 5.1.1 Self-signed Certificates

If using a self-signed CA, inform K8s of the CA. Example files: `config/certificate/ca.crt`, `config/certificate/ca.key`, and `config/certificate/server.crt`.

Update the "CABundle" field in webhook configs with the new CA certificate (base64 encoded).

#### 5.1.2 Legal Certificates

With a legal certificate, remove the "CABundle" field and set the domain to your own in the webhook configs.
